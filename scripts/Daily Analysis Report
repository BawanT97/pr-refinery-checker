import os
import requests
import pandas as pd
import io
from datetime import datetime

# Box Developer Token (from GitHub Secrets)
BOX_ACCESS_TOKEN = os.environ.get('BOX_API_KEY', '')
BOX_FOLDER_ID = '360216207983'  # Daily Analysis Report folder

print("="*80)
print(f"DAILY ANALYSIS REPORT - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print("="*80)

if not BOX_ACCESS_TOKEN:
    print("ERROR: BOX_API_KEY environment variable not set!")
    exit(1)

headers = {
    'Authorization': f'Bearer {BOX_ACCESS_TOKEN}',
}

# Get all files in the folder
print(f"\nFetching files from Box folder ID: {BOX_FOLDER_ID}")
url = f'https://api.box.com/2.0/folders/{BOX_FOLDER_ID}/items'
response = requests.get(url, headers=headers)

if response.status_code != 200:
    print(f"ERROR: Failed to fetch folder contents: {response.status_code}")
    print(response.text)
    exit(1)

items = response.json().get('entries', [])
print(f"Found {len(items)} items in folder\n")

# Process each file
for item in items:
    if item['type'] != 'file':
        continue
    
    file_id = item['id']
    file_name = item['name']
    file_ext = os.path.splitext(file_name)[1].lower()
    
    print("="*80)
    print(f"FILE: {file_name}")
    print("="*80)
    
    # Download file content
    download_url = f'https://api.box.com/2.0/files/{file_id}/content'
    file_response = requests.get(download_url, headers=headers)
    
    if file_response.status_code != 200:
        print(f"ERROR: Failed to download {file_name}: {file_response.status_code}")
        continue
    
    try:
        # Read Excel files
        if file_ext in ['.xlsx', '.xls']:
            excel_file = pd.ExcelFile(io.BytesIO(file_response.content))
            print(f"Excel sheets: {excel_file.sheet_names}\n")
            
            for sheet_name in excel_file.sheet_names:
                print(f"--- SHEET: {sheet_name} ---")
                df = pd.read_excel(excel_file, sheet_name=sheet_name)
                print(f"Rows: {len(df)}, Columns: {len(df.columns)}\n")
                
                # Print column names
                print("COLUMNS:")
                for col in df.columns:
                    print(f"  - {col}")
                print()
                
                # Print ALL rows of data
                print("DATA:")
                for idx, row in df.iterrows():
                    print(f"Row {idx+1}:")
                    for col in df.columns:
                        value = row[col]
                        if pd.notna(value):
                            print(f"  {col}: {value}")
                    print()
                print()
        
        # Read CSV files
        elif file_ext == '.csv':
            df = pd.read_csv(io.BytesIO(file_response.content))
            print(f"Rows: {len(df)}, Columns: {len(df.columns)}\n")
            
            # Print column names
            print("COLUMNS:")
            for col in df.columns:
                print(f"  - {col}")
            print()
            
            # Print ALL rows of data
            print("DATA:")
            for idx, row in df.iterrows():
                print(f"Row {idx+1}:")
                for col in df.columns:
                    value = row[col]
                    if pd.notna(value):
                        print(f"  {col}: {value}")
                print()
        
        # Read PDF files
        elif file_ext == '.pdf':
            try:
                import pdfplumber
                with pdfplumber.open(io.BytesIO(file_response.content)) as pdf:
                    print(f"Total pages: {len(pdf.pages)}\n")
                    for page_num, page in enumerate(pdf.pages, 1):
                        print(f"--- PAGE {page_num} ---")
                        text = page.extract_text()
                        if text:
                            print(text)
                        print()
            except:
                try:
                    from pypdf import PdfReader
                    pdf = PdfReader(io.BytesIO(file_response.content))
                    print(f"Total pages: {len(pdf.pages)}\n")
                    for page_num, page in enumerate(pdf.pages, 1):
                        print(f"--- PAGE {page_num} ---")
                        text = page.extract_text()
                        if text:
                            print(text)
                        print()
                except Exception as e:
                    print(f"ERROR reading PDF: {e}")
        
        else:
            print(f"Unsupported file type: {file_ext}")
    
    except Exception as e:
        print(f"ERROR processing {file_name}: {e}")
    
    print()

print("="*80)
print("REPORT COMPLETE")
print("="*80)
